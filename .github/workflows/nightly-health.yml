name: Nightly Health Check

on:
  schedule:
    # 8am Central Time (1pm UTC during CDT, most of year)
    - cron: '0 13 * * *'
  workflow_dispatch: # manual trigger

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Full Site Health Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --include=dev

      - name: Article validation
        id: articles
        run: node tests/article-validation.mjs 2>&1 | tee /tmp/articles.txt
        continue-on-error: true

      - name: Tour validation
        id: tours
        run: node tests/tour-validation.mjs 2>&1 | tee /tmp/tours.txt
        continue-on-error: true

      - name: Build site
        run: npm run build

      - name: Build validation
        id: build
        run: node tests/build-validation.mjs 2>&1 | tee /tmp/build.txt
        continue-on-error: true

      - name: Auto-fix dry run
        run: node tests/auto-fix.mjs --dry-run 2>&1 | tee /tmp/autofix.txt
        continue-on-error: true

      - name: Create health report issue
        if: steps.articles.outcome == 'failure' || steps.tours.outcome == 'failure' || steps.build.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const articles = fs.readFileSync('/tmp/articles.txt', 'utf-8');
            const tours = fs.readFileSync('/tmp/tours.txt', 'utf-8');
            const build = fs.readFileSync('/tmp/build.txt', 'utf-8');
            const autofix = fs.readFileSync('/tmp/autofix.txt', 'utf-8');

            const artStatus = '${{ steps.articles.outcome }}' === 'success' ? '‚úÖ' : '‚ùå';
            const tourStatus = '${{ steps.tours.outcome }}' === 'success' ? '‚úÖ' : '‚ùå';
            const buildStatus = '${{ steps.build.outcome }}' === 'success' ? '‚úÖ' : '‚ùå';

            const body = `## Nightly Health Check ‚Äî ${new Date().toISOString().split('T')[0]}

            | Check | Status |
            |-------|--------|
            | Article Validation | ${artStatus} |
            | Tour & Affiliate | ${tourStatus} |
            | Build Output | ${buildStatus} |

            ### Article Validation
            \`\`\`
            ${articles.slice(-2000)}
            \`\`\`

            ### Tour Validation
            \`\`\`
            ${tours.slice(-1000)}
            \`\`\`

            ### Build Validation
            \`\`\`
            ${build.slice(-1000)}
            \`\`\`

            ### Auto-Fix Candidates
            \`\`\`
            ${autofix.slice(-2000)}
            \`\`\`

            ---
            ü§ñ *Generated by CursedTours Nightly Health Check*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üè• Health Check: ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['health-check', 'automated']
            });

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_number }}
          path: |
            /tmp/articles.txt
            /tmp/tours.txt
            /tmp/build.txt
            /tmp/autofix.txt
            tests/fix-report.json
          retention-days: 30
